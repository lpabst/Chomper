<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chomper</title>
</head>

<body>
    <style>
        #gameCanvas {
            width: 1000px;
            height: 600px;
            background: black;
        }
    </style>

    <main>
        <canvas id='gameCanvas'></canvas>
    </main>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script>
        // set the w/h of the canvas
        document.getElementById('gameCanvas').width = 1000;
        document.getElementById('gameCanvas').height = 600;

        // types
        var WALL = 'WALL';
        var PLAYER = 'PLAYER';
        var FOOD = 'FOOD';
        var SCORE = 'SCORE';

        function random(low, high, includeHigh) {
            let inclusiveIncrementer = includeHigh ? 1 : 0
            return Math.floor(Math.random() * (high - low + inclusiveIncrementer)) + low;
        }

        // Player input
        var Input = {
            init: function (data) {
                var self = this;

                $(window).on('keydown', function () {
                    Input.helpers.down[event.keyCode] = true;
                });

                $(window).keyup(function () {
                    delete Input.helpers.down[event.keyCode];
                    delete Input.helpers.pressed[event.keyCode];
                })
            },

            update: function (data) {
                var player = data.entities.player;
                var leftArrowDown = Input.helpers.isDown(37);
                var rightArrowDown = Input.helpers.isDown(39);
                var upArrowDown = Input.helpers.isDown(38);
                var downArrowDown = Input.helpers.isDown(40);

                player.direction = {
                    left: false,
                    up: false,
                    right: false,
                    down: false
                }

                if (leftArrowDown) {
                    player.x -= player.velX
                    player.direction.left = true;
                }

                if (rightArrowDown) {
                    player.x += player.velX;
                    player.direction.right = true;
                }

                if (upArrowDown) {
                    player.y -= player.velY;
                    player.direction.up = true;
                }

                if (downArrowDown) {
                    player.y += player.velY;
                    player.direction.down = true;
                }
            },

            helpers: {
                isDown: function (code) {
                    return Input.helpers.down[code];
                },

                isPressed: function (code) {
                    if (Input.helpers.pressed[code]) {
                        return false;
                    } else if (Input.helpers.down[code]) {
                        return Input.helpers.pressed[code] = true;
                    } else {
                        return false;
                    }
                },

                down: {},
                pressed: {},
            },
        }

        // Entities Script
        var Entities = {
            init: function (data) {
                var background = {
                    x: 0,
                    y: 0,
                    w: 1000,
                    h: 800,
                };

                var player = new Entities.helpers.player(300, 300, 20, 20);
                var score = new Entities.helpers.Score(290, 70);

                var wallLocations = [[0, 0, 1000, 8], [0, 0, 8, 1000], [0, 1000, 1000, 8], [1000, 0, 8, 1000], [80, 420, 420, 8],
                [20, 20, 600, 8], [620, 20, 8, 80], [120, 100, 480, 8], [120, 45, 8, 55], [200, 20, 8, 55], [300, 45, 8, 55], [400, 20, 8, 55]];
                var foodLocations = [
                    [10, 20, 1],
                    [50, 50, 2],
                    [200, 80, 1]
                ]

                data.entities = {
                    background: background,
                    player: player,
                    score: score,
                    wallsArray: [],
                    foodArray: [],
                };

                wallLocations.forEach(function (wall) {
                    data.entities.wallsArray.push(new Entities.helpers.Wall(wall[0], wall[1], wall[2], wall[3]))
                })

                // put pieces of food on the board
                foodLocations.forEach(function (food) {
                    data.entities.foodArray.push(new Entities.helpers.Food(food[0], food[1], food[2]))
                })
            },

            update: function (data) {
                data.entities.player.update();
            },

            helpers: {
                player: function (x, y, w, h) {
                    var self = this;
                    this.type = PLAYER;
                    this.points = 0;

                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                    this.direction = 'right';
                    this.velY = 3;
                    this.velX = 3;
                    this.resetVelX = 3;
                    this.resetVelY = 3;

                    this.update = function () {
                        this.velX = this.resetVelX;
                        this.velY = this.resetVelY;
                    }
                },

                Wall: function (x, y, w, h) {
                    this.type = WALL;
                    this.x = x;
                    this.y = y;
                    this.w = w;
                    this.h = h;
                },

                Food: function (x, y, val) {
                    this.getColor = function () {
                        let colorMap = {
                            1: 'blue',
                            2: 'green',
                            3: 'red',
                            4: 'purple',
                            5: 'aqua'
                        }
                        return colorMap[this.value]
                    }

                    this.x = x ? x : random(0, data.canvas.width)
                    this.y = y ? y : random(0, data.canvas.height)
                    this.w = 12;
                    this.h = 12;
                    this.size = '15px';
                    this.font = 'Arial';
                    this.value = val;
                    this.color = this.getColor();
                    this.type = FOOD;
                },

                Score: function (x, y) {
                    this.x = x;
                    this.y = y;
                    this.value = 0;
                    this.size = "25px";
                    this.font = 'Arial';
                    this.color = 'green';
                    this.type = SCORE;
                },
            }
        }

        // Render Script
        var Render = {
            init: function (data) {
                Render.helpers.drawEntity(data.entities.background, data.canvas.context);
            },

            update: function (data) {
                data.canvas.context.clearRect(0, 0, data.canvas.canvas.width, data.canvas.canvas.height);

                Render.helpers.drawText(data.entities.score, data.canvas.context, "Points: ");
                Render.helpers.drawEntity(data.entities.player, data.canvas.context);

                data.entities.wallsArray.forEach(function (wall) {
                    Render.helpers.drawEntity(wall, data.canvas.context, 'white');
                });
                data.entities.foodArray.forEach(function (food) {
                    Render.helpers.drawEntity(food, data.canvas.context, food.color);
                })
            },

            helpers: {
                drawEntity: function (entity, ctx, color) {
                    ctx.fillStyle = color ? color : 'white';
                    ctx.fillRect(entity.x, entity.y, entity.w, entity.h);
                },

                drawText: function (text, ctx, prefix) {
                    prefix = prefix ? prefix : '';
                    ctx.font = text.size + ' ' + text.font;
                    ctx.fillStyle = text.color;
                    ctx.fillText(prefix + text.value, text.x, text.y);
                }
            }
        }

        // Physics Script
        var Physics = {
            update: function (data) {
                Physics.collisionDetection(data);
            },

            collisionDetection: function (data) {
                var player = data.entities.player;

                var entityCollisionCheck = function (entity) {
                    if (player.x < entity.x + entity.w &&
                        player.x + player.w > entity.x &&
                        player.y < entity.y + entity.h &&
                        player.y + player.h > entity.y) {
                        // Collision occurred
                        Physics.handleCollision(data, entity);
                    }
                }

                data.entities.wallsArray.forEach(function (wall) {
                    entityCollisionCheck(wall);
                })
                data.entities.foodArray.forEach(function (food) {
                    entityCollisionCheck(food);
                })
            },

            handleCollision(data, entity) {
                var player = data.entities.player;
                var playerLeftSide = player.x;
                var playerRightSide = player.x + player.w;
                var playerTopSide = player.y;
                var playerBottomSide = player.y + player.h;

                if (entity.type === WALL) {
                    var wallLeftSide = entity.x;
                    var wallRightSide = entity.x + entity.w;
                    var wallTopSide = entity.y;
                    var wallBottomSide = entity.y + entity.h;
                    // if the user is barely in the wall they can still move since we don't move them pixel by pixel and they might jump into it slightly
                    var allowanceBuffer = player.resetVelX;

                    // player is in between the walls borders and not trying to move the other way
                    if (!player.direction.right &&
                        playerLeftSide > wallLeftSide &&
                        playerLeftSide < wallRightSide &&
                        playerRightSide > wallRightSide &&
                        playerTopSide < wallBottomSide - allowanceBuffer &&
                        playerBottomSide > wallTopSide + allowanceBuffer) {
                        player.velX = 0;
                    }

                    if (!player.direction.left &&
                        playerRightSide > wallLeftSide &&
                        playerRightSide < wallRightSide &&
                        playerLeftSide < wallLeftSide &&
                        playerTopSide < wallBottomSide - allowanceBuffer &&
                        playerBottomSide > wallTopSide + allowanceBuffer) {
                        player.velX = 0;
                    }

                    if (!player.direction.down &&
                        playerTopSide > wallTopSide &&
                        playerTopSide < wallBottomSide &&
                        playerBottomSide > wallBottomSide &&
                        playerLeftSide < wallRightSide - allowanceBuffer &&
                        playerRightSide > wallLeftSide + allowanceBuffer) {
                        player.velY = 0;
                    }

                    if (!player.direction.up &&
                        playerBottomSide > wallTopSide &&
                        playerBottomSide < wallBottomSide &&
                        playerTopSide < wallTopSide &&
                        playerLeftSide < wallRightSide - allowanceBuffer &&
                        playerRightSide > wallLeftSide + allowanceBuffer) {
                        player.velY = 0;
                    }
                }

                if (entity.type === FOOD) {
                    // adjust the score
                    data.entities.score.value += entity.value;

                    // remove the food from the array
                    let indexToRemove = data.entities.foodArray.indexOf(entity);
                    data.entities.foodArray.splice(indexToRemove, 1)

                    // check if the level is complete
                    if (data.entities.foodArray.length === 0) {
                        // go to the next level at some point
                    }
                }
            }
        }

        // Game Script
        var Game = {
            init: function () {
                var cv = document.getElementById('gameCanvas');
                var ctx = cv.getContext('2d');

                var canvas = {
                    canvas: cv,
                    context: ctx
                }

                var data = {
                    animationFrame: 0,
                    canvas: canvas
                }

                Entities.init(data);
                Input.init(data);
                Render.init(data);

                Game.run(data);
            },

            run: function (data) {
                var loop = function () {
                    Game.input(data);
                    Game.update(data);
                    Game.render(data);

                    data.animationFrame++;

                    window.requestAnimationFrame(loop);
                }

                loop();
            },

            input: function (data) {
                Input.update(data);
            },

            update: function (data) {
                Entities.update(data);
                Physics.update(data);
            },

            render: function (data) {
                Render.update(data);
            },
        }

        Game.init();
    </script>

</body>

</html>